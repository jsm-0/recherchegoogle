Lien du dépôt GitHub: https://github.com/jsm-0/recherchegoogle.git

# Rapport d'Audit de Sécurité - Projet Fil Rouge

Ce rapport détaille les vulnérabilités détectées, les mesures correctives recommandées, et les correctifs appliqués au projet.

## 1. Vulnérabilités Détectées (10 / 20)

Une analyse du code source (fichiers `submit.php` et `comments.php`) a révélé plusieurs failles critiques de sécurité.

### 1.1. Injection SQL (Critique)
**Fichier :** `submit.php`
**Description :** Les données utilisateur (`$_POST["content"]`) sont directement concaténées dans la requête SQL sans aucune validation ni échappement. Cela permet à un attaquant de manipuler la requête SQL pour voler des données, supprimer la base de données ou contourner l'authentification.

**Preuve (Code) :**
```php
// submit.php, ligne 14
$sql="INSERT INTO comments (content) VALUES ('" . $content ."')";
$pdo->exec($sql);
```
Un attaquant peut envoyer `' OR '1'='1` ou `'); DROP TABLE comments; --` pour exécuter du code malveillant.

### 1.2. Divulgation d'Informations Sensibles (Moyenne)
**Fichier :** `comments.php` et `submit.php`
**Description :** Les identifiants de connexion à la base de données sont codés en dur (« hardcoded ») directement dans les fichiers PHP. Si le code source fuite ou est accessible (ex: mauvaise configuration serveur), les attaquants obtiennent l'accès complet à la base de données.

**Preuve (Code) :**
```php
$host = "127.0.0.1";
$db="tp_comments";
$user="root"; // Identifiant visible
$pass="";     // Mot de passe visible
```

### 1.3. Mauvaise Gestion des Erreurs (Faible)
**Fichier :** `submit.php`
**Description :** En cas d'erreur SQL, le script affiche le message d'erreur brut retourné par la base de données à l'utilisateur. Cela peut révéler la structure des tables ou le type de base de données utilisée.

**Preuve (Code) :**
```php
// submit.php, ligne 19
echo "Erreur SQL :" .$e->getMessage();
```

### 1.4. Bug Logique et Syntaxique (Disponibilité)
**Fichier :** `submit.php`
**Description :** Le code contient des erreurs qui empêchent son fonctionnement (Déni de Service involontaire).
1. La variable `$pdo` est écrasée par une chaîne de caractères (ligne 13), rendant l'appel `$pdo->exec()` impossible.
2. Une erreur de syntaxe (`$`) est présente à la fin de la ligne 19.

**Preuve (Code) :**
```php
$pdo="INSERT INTO comments(conten) VALUES ('" . $content ."')"; // $pdo n'est plus un objet
// ...
$pdo->exec($sql); // Crash : méthode exec() sur une string
```

### 1.5. Absence de Protection CSRF (Moyenne)
**Description :** Aucun jeton anti-CSRF n'est vérifié lors de la soumission du formulaire. Un site malveillant pourrait forcer un utilisateur à poster des commentaires à son insu.

---

## 2. Mesures Correctives à Mettre en Place (6 / 20)

Pour sécuriser l'application, les mesures suivantes sont nécessaires :

1.  **Utilisation de Requêtes Préparées (Prepared Statements)** : Remplacer la concaténation de chaînes par des requêtes paramétrées (PDO) pour éliminer totalement les injections SQL.
2.  **Externalisation de la Configuration** : Déplacer les identifiants de base de données dans un fichier séparé (ex: `db.php` ou `.env`) qui peut être exclu du contrôle de version ou protégé.
3.  **Gestion Propre des Erreurs** : Ne jamais afficher les erreurs brutes à l'utilisateur. Utiliser un journal d'erreurs (logs) et afficher un message générique ("Une erreur est survenue").
4.  **Validation des Données** : Vérifier que le contenu n'est pas vide avant l'insertion.
5.  **Correction des Bugs** : Supprimer le code mort et corriger les erreurs de syntaxe pour assurer la disponibilité du service.

---

## 3. Mesures Correctives Mises en Place et Implémentées (4 / 20)

Les correctifs suivants ont été appliqués au code source :

### 3.1. Correction de l'Injection SQL (Implémenté)
Le fichier `submit.php` a été réécrit pour utiliser des **requêtes préparées** (Prepared Statements). Les données ne sont plus concaténées mais passées en paramètres séparés, neutralisant toute tentative d'injection SQL.

**Code corrigé (`submit.php`) :**
```php
$stmt = $pdo->prepare("INSERT INTO comments (content) VALUES (:content)");
$stmt->execute([':content' => $content]);
```

### 3.2. Centralisation et Sécurisation de la Connexion (Implémenté)
Création d'un fichier `db.php` contenant la connexion PDO. Ce fichier est ensuite inclus via `require 'db.php'` dans `comments.php` et `submit.php`. Cela facilite la maintenance et évite de dupliquer les identifiants (réduction de la surface d'attaque).

**Fichier `db.php` :**
```php
$host = '127.0.0.1';
// ...
try {
    $pdo = new PDO($dsn, $user, $pass);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
}
```

### 3.3. Gestion Sécurisée des Erreurs (Implémenté)
L'affichage des erreurs SQL brutes (`$e->getMessage()`) a été supprimé des pages visibles par l'utilisateur. Elles sont désormais envoyées dans les logs serveur (`error_log`) et un message générique est affiché pour ne pas divulguer d'informations techniques.

**Exemple (`submit.php` & `comments.php`) :**
```php
} catch (PDOException $e) {
    error_log($e->getMessage()); // Log erreur interne
    echo "Une erreur est survenue lors de l'enregistrement..."; // Message user-friendly
}
```

### 3.4. Validation des Entrées (Implémenté)
Ajout d'une vérification avec `trim()` et `empty()` pour s'assurer que seuls des commentaires non vides sont enregistrés.

### 3.5. Correction des Bugs Fonctionnels (Implémenté)
Le code de `submit.php` a été nettoyé : correction de l'écrasement de la variable `$pdo` et de l'erreur de syntaxe qui provoquait un crash systématique.
De plus, le formulaire d'ajout de commentaire manquant a été ajouté à la page `index.html`.